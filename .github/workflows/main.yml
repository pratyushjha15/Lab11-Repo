# .github/workflows/main.yml
name: CI/CD Pipeline

# Triggers the workflow on any push to the 'main' branch
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    # Checks out your repository code
    - name: Check out code
      uses: actions/checkout@v3

    # TASK 1 (Part 1): Build and Test
    # Sets up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # Installs dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    # A simple "test" to satisfy the requirement
    - name: Run simple test
      run: |
        pip install flask
        flask --version # If this runs, flask is installed
    
    # TASK 2: Containerize
    # Logs in to Docker Hub using your secrets
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        # These lines pull from your GitHub Secrets.
        # DO NOT write your username or password here.
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # Builds and tags the Docker image
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: true # Build and push in one step
        tags: ${{ secrets.DOCKER_USERNAME }}/lab11-repo:latest
